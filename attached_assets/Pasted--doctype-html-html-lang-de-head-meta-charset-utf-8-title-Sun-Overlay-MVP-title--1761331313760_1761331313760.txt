<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Sun Overlay MVP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body,#map{height:100%;margin:0}
    .ui{position:absolute;top:12px;right:12px;background:#fff8;border:1px solid #0002;padding:10px;font:14px/1.3 system-ui}
    .ui label{display:block;margin-bottom:6px}
    .legend{position:absolute;left:12px;bottom:12px;background:#fff8;border:1px solid #0002;padding:6px 8px;font:12px system-ui}
  </style>
  <!-- SunCalc (CDN) -->
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
  <!-- Google Maps JS API (ersetze YOUR_KEY) -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_KEY&callback=initMap&libraries=geometry">
  </script>
</head>
<body>
  <div id="map"></div>

  <div class="ui">
    <label>
      Datum/Uhrzeit:
      <input id="dt" type="datetime-local" />
    </label>
    <label>
      Länge des Rays (m):
      <input id="len" type="number" value="400" min="50" max="2000" step="50"/>
    </label>
  </div>

  <div class="legend">Sonnenrichtung = <span style="color:#B26E4B;">Ray</span> · Tagesbahn optional später</div>

  <script>
    // ***** Konfig *****
    const POS = { lat: 52.520008, lng: 13.404954 }; // Beispiel: Berlin Mitte
    const TZ = "Europe/Berlin";

    let map, marker, ray;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: POS, zoom: 16, mapTypeId: "hybrid",
        clickableIcons: false, streetViewControl: false, fullscreenControl: false
      });

      marker = new google.maps.Marker({ position: POS, map, title: "Objekt" });

      ray = new google.maps.Polyline({
        map, geodesic: true, strokeColor: "#B26E4B", strokeOpacity: 0.6, strokeWeight: 3, path: [POS, POS]
      });

      // UI init
      const dt = document.getElementById("dt");
      // Default: jetzt (lokal)
      dt.value = toLocalInputValue(new Date());
      dt.addEventListener("input", drawRay);

      document.getElementById("len").addEventListener("input", drawRay);

      drawRay();
    }

    function drawRay() {
      const dtEl = document.getElementById("dt");
      const len = Number(document.getElementById("len").value) || 400;

      const when = dtEl.value ? new Date(dtEl.value) : new Date();

      // SunCalc: azimuth (von Süden, Westen positiv) + altitude
      const pos = SunCalc.getPosition(when, POS.lat, POS.lng);
      const bearing = (rad2deg(pos.azimuth) + 180) % 360; // zu Kompasslager (0=N)
      // Wenn unter Horizont → gestrichelt
      ray.setOptions({ strokeOpacity: pos.altitude < 0 ? 0.4 : 0.6, strokeOpacity:  pos.altitude < 0 ? 0.4 : 0.6, strokeColor: "#B26E4B", icons: pos.altitude < 0 ? [{
        icon: { path: "M 0,-1 0,1", strokeOpacity: 1, scale: 4 }, offset: "0", repeat: "12px"
      }] : null });

      const end = destPoint(POS, bearing, len);
      ray.setPath([POS, end]);
    }

    // Hilfsfunktionen
    function rad2deg(r){ return r * (180/Math.PI); }

    // Zielpunkt aus Start(lat,lng), Bearing(°), Distanz(m)
    function destPoint(start, bearingDeg, distM){
      const R = 6371000;
      const brng = bearingDeg * Math.PI/180;
      const lat1 = start.lat * Math.PI/180;
      const lon1 = start.lng * Math.PI/180;
      const dr = distM / R;

      const lat2 = Math.asin( Math.sin(lat1)*Math.cos(dr) + Math.cos(lat1)*Math.sin(dr)*Math.cos(brng) );
      const lon2 = lon1 + Math.atan2(Math.sin(brng)*Math.sin(dr)*Math.cos(lat1), Math.cos(dr)-Math.sin(lat1)*Math.sin(lat2));
      return { lat: lat2*180/Math.PI, lng: lon2*180/Math.PI };
    }

    function toLocalInputValue(d){
      // auf lokale TZ normalisieren, Sekunden entfernen
      const pad = n => String(n).padStart(2,"0");
      const y = d.getFullYear();
      const m = pad(d.getMonth()+1);
      const da = pad(d.getDate());
      const h = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${y}-${m}-${da}T${h}:${mi}`;
    }

    // global für Google callback
    window.initMap = initMap;
  </script>
</body>
</html>
