REPLIT-WEISUNG — TASK 7 (wrangler.toml: R2-Bindings, Secrets, Routes)

Ziel:
Cloudflare Workers so konfigurieren, dass die Hono-Edge-App mit Canary + Proxy läuft und Zugriff auf R2 (piximmo-media) hat. Keine Codeänderungen an Handlern.

Leitplanken:
- Keine Funktionslogik ändern.
- Nur Konfiguration: wrangler.toml + Secrets.
- Staging/Preview und Prod trennen.

Änderungen (nur diese Dateien/Schritte):
1) wrangler.toml anlegen/ergänzen:
---------------------------------
name = "pixcapture-api"
main = "workers/edge.ts"
compatibility_date = "2025-11-01"

# Routen (Beispiel; Domain anpassen)
routes = [
  { pattern = "api-preview.pix.immo/api/*", zone_name = "pix.immo" },
  { pattern = "api.pix.immo/api/*", zone_name = "pix.immo" }
]

[vars]
ORIGIN_API_BASE = "https://api.alt-backend.example"   # Platzhalter, nicht hardcoden für Prod
ALLOWED_ORIGINS = "https://pix-immo.pages.dev,https://www.pix.immo"
COOKIE_SAMESITE = "None"
COOKIE_SECURE = "true"

[r2_buckets]
# Binding-Name MUSS exakt so in den Upload-Handlern genutzt werden
binding = "R2_BUCKET"
bucket_name = "piximmo-media"
preview_bucket_name = "piximmo-media"  # optional

[observability]
enabled = true

2) Secrets setzen (in Replit/Cloudflare):
-----------------------------------------
wrangler secret put JWT_SECRET
wrangler secret put ORIGIN_API_BASE    # Falls als Secret statt var verwendet
# Optional: weitere Secrets (z. B. DB_URL) erst in späterem Halt

3) Lokale/Preview-Konfig prüfen:
--------------------------------
- PREVIEW: ALLOWED_ORIGINS enthält Pages-Preview-Domain
- COOKIE_SAMESITE=None, COOKIE_SECURE=true belassen
- Keine Wildcards in ALLOWED_ORIGINS

4) Sanity-Check:
----------------
- wrangler deploy --dry-run
- wrangler deploy (Preview-Env)
- GET https://api-preview.pix.immo/api/healthz → 200 ohne Proxy
- Mit Header X-Canary: 1: GET /api/orders/{id}/files → native Handler antwortet
- Ohne Canary: gleicher Call → via Proxy an ORIGIN_API_BASE

Definition of Done:
- wrangler.toml mit R2-Binding & Routes vorhanden
- Secrets gesetzt (JWT_SECRET)
- Healthz erreichbar
- Canary/Proxy-Pfade unterscheiden sich wie erwartet

Cleanup:
- Keine sensiblen Werte in wrangler.toml commiten (nur Platzhalter)
- README: kurzer Abschnitt „wrangler.toml Bindings & Deploy“ ergänzen (1 Absatz)
