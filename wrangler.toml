# =============================================================================
# HALT B1 - Cloudflare Workers Configuration (Edge API)
# =============================================================================
# Migration von Express (server/index.ts) zu Hono Workers (workers/edge.ts)
# Staged Rollout: Canary-Header steuert native Handlers vs. Proxy-Fallback

name = "pixcapture-api"
main = "workers/edge.ts"
compatibility_date = "2025-11-01"
compatibility_flags = ["nodejs_compat"]

# =============================================================================
# Environment Variables (non-secret)
# =============================================================================
[vars]
# Proxy-Fallback: Alt-Backend URL (DO NOT hardcode production URLs in repo)
ORIGIN_API_BASE = "https://api-origin.example.com"

# CORS: Comma-separated allowed origins (Pages Preview + Production)
ALLOWED_ORIGINS = "https://pix-immo.pages.dev,https://www.pix.immo,https://pix.immo"

# Cookie Settings (required for cross-domain auth)
COOKIE_SAMESITE = "None"
COOKIE_SECURE = "true"

# Feature Flags (Canary-Rollout)
PHASE_B1B_ENABLED = "true"  # Enable native upload handlers (B1b)

# B2a - Production Canary Configuration
# NOTE: CANARY_PERCENT moved to Workers KV for instant rollback (no redeploy)
# Access KV at runtime via env.KV_CANARY_CONFIG
FEATURE_QA_GUARD = "true"   # Enable /qa endpoint for production validation
CANARY_TAG = "B2a"          # Rollout phase identifier (for observability)

# =============================================================================
# R2 Bucket Bindings (Object Storage)
# =============================================================================
[[r2_buckets]]
binding = "R2_BUCKET"           # MUST match workers/edge.ts usage
bucket_name = "piximmo-media"   # Production bucket
preview_bucket_name = "piximmo-media"  # Preview uses same bucket (staging data)

# =============================================================================
# Workers KV Namespaces (B2a - Canary Configuration)
# =============================================================================
# KV stores canary_percent, canary_tag, emergency_proxy for instant rollback
# Create namespace: wrangler kv:namespace create "canary-config"
# Seed data: wrangler kv:key put --binding=KV_CANARY_CONFIG config --value '{"canary_percent":10,"canary_tag":"B2a","emergency_proxy":false}'

[[kv_namespaces]]
binding = "KV_CANARY_CONFIG"
id = "placeholder_replace_after_creation"  # Run: wrangler kv:namespace create "canary-config"
preview_id = "placeholder_replace_after_creation"  # Run: wrangler kv:namespace create "canary-config" --preview

# =============================================================================
# Cloudflare Routes (API Endpoints)
# =============================================================================
# Preview Environment (for testing before production)
[[routes]]
pattern = "api-preview.pix.immo/api/*"
zone_name = "pix.immo"

# Production Environment
[[routes]]
pattern = "api.pix.immo/api/*"
zone_name = "pix.immo"

# =============================================================================
# Observability (Logs & Analytics)
# =============================================================================
[observability]
enabled = true

# =============================================================================
# Secrets (DO NOT commit values - set via wrangler CLI)
# =============================================================================
# Required Secrets (set via: wrangler secret put SECRET_NAME):
#
# - DATABASE_URL          PostgreSQL connection string (Neon)
# - SESSION_SECRET        Express session encryption key
# - JWT_SECRET            JSON Web Token signing key (if used)
# - ORIGIN_API_BASE       (Optional as secret) Alt-backend URL for proxy fallback
#
# Optional Secrets:
# - REPLICATE_API_TOKEN   AI image processing (captioning, upscaling)
# - RESEND_API_KEY        Email service (notifications)
# - STRIPE_SECRET_KEY     Payment processing (prod)
# - TESTING_STRIPE_SECRET_KEY  Payment processing (test mode)
#
# Set secrets in production:
#   wrangler secret put DATABASE_URL
#   wrangler secret put SESSION_SECRET
#   wrangler secret put JWT_SECRET
#
# Set secrets in preview:
#   wrangler secret put DATABASE_URL --env preview
#   wrangler secret put SESSION_SECRET --env preview

# =============================================================================
# Environment-Specific Overrides
# =============================================================================

# Preview Environment (for staging/testing)
[env.preview]
name = "pixcapture-api-preview"

[env.preview.vars]
APP_ENV = "preview"
ORIGIN_API_BASE = "https://api-preview.pix.immo"
ALLOWED_ORIGINS = "https://pix-immo.pages.dev,https://preview.pix.immo"
PHASE_B1B_ENABLED = "true"
FEATURE_QA_GUARD = "true"

[[env.preview.routes]]
pattern = "api-preview.pix.immo/api/*"
zone_name = "pix.immo"

# Production Environment
[env.production]
name = "pixcapture-api"

[env.production.vars]
APP_ENV = "production"
ORIGIN_API_BASE = "https://api.pix.immo"
ALLOWED_ORIGINS = "https://www.pix.immo,https://pix.immo"
PHASE_B1B_ENABLED = "true"
FEATURE_QA_GUARD = "true"

[[env.production.routes]]
pattern = "api.pix.immo/api/*"
zone_name = "pix.immo"

# =============================================================================
# Legacy Config (OLD: server/index.ts - kept for reference)
# =============================================================================
# Uncomment below to revert to Express-based deployment:
#
# name = "piximmo-app"
# main = "server/index.ts"
# compatibility_date = "2025-10-01"
# 
# [[r2_buckets]]
# binding = "R2_BUCKET"
# bucket_name = "piximmo"
# preview_bucket_name = "piximmo-dev"
#
# [build]
# command = "npm run build"
